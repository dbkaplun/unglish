<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Unglish</title>
    <link rel="stylesheet" href="//cdn.quilljs.com/1.0.6/quill.bubble.css">
    <style>
html, body { margin: 0; height: 100%; }
    </style>
  </head>
  <body>
    <div id="quill"></div>
    <script src="//cdn.quilljs.com/1.0.6/quill.min.js" type="text/javascript"></script>
    <script>
function parse (text) {
  let body = new URLSearchParams();
  body.set('text', text);
  return fetch('/api/parse', {method: 'POST', body}).then(res => res.json());
}

let quill = new Quill('#quill', {
  modules: {toolbar: false},
  placeholder: 'Enter some text...',
  theme: 'bubble'
});

quill.on('text-change', (newDelta, oldDelta, source) => {
  if (source !== 'user') return;
  let text = quill.getText();
  parse(text).then(terms => {
    console.log('parsed:', JSON.stringify(text), terms);
    var range = quill.getSelection();
    quill.setContents(terms.reduce((deltas, term) => {
      if (term.text) {
        let {whitespace} = term;
        if (whitespace.preceding) deltas.push({insert: whitespace.preceding});
        deltas.push({
          insert: term.text,
          attributes: {
            Copula: {color: 'gray'}, /* is */
            Determiner: {color: 'gray'}, /* a */
            Preposition: {color: 'gray'}, /* in */
            Noun: {color: 'blue'}, /* world */
            Infinitive: {color: 'blue'}, /* test */
            Adjective: {color: 'green'}, /* awesome */
            Adverb: {color: 'yellow'}, /* so */
            PastTense: {color: 'gold'}, /* let */
            Verb: {color: 'gold'}, /* let */
            Question: {color: 'orange'}, /* so */
            Expression: {color: 'red'}, /* hello */
            Pronoun: {color: 'red'}, /* me */
            Demonym: {color: 'pink'}, /* English */
          }[term.tag] || {background: 'red'}
        });
        if (whitespace.trailing) deltas.push({insert: whitespace.trailing});
      }
      return deltas;
    }, []));
    quill.setSelection(range);
  });
});
     </script>
  </body>
</html>
